{% extends 'base.html' %}
{% block title %}Easy Bilan Hebdo{% endblock %}
{% block content %}

<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .bilan-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-bilan {
        text-align: center;
        color: white;
        margin-bottom: 40px;
    }

    .header-bilan h1 {
        font-size: 2.2em;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-bilan p {
        font-size: 1.1em;
        opacity: 0.95;
    }

    /* Athletes grid */
    .athletes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    /* Athlete card */
    .athlete-card {
        background: white;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        border-left: 6px solid #667eea;
    }

    .athlete-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    }

    .athlete-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .athlete-name {
        font-size: 1.3em;
        font-weight: 700;
        margin: 0;
    }

    .athlete-weeks {
        font-size: 0.9em;
        opacity: 0.9;
        margin-top: 5px;
    }

    .athlete-body {
        padding: 20px;
    }

    .summary-table {
        width: 100%;
        border-collapse: collapse;
    }

    .summary-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
    }

    .summary-table tbody tr:last-child {
        border-bottom: none;
    }

    .summary-table td {
        padding: 14px 12px;
        vertical-align: middle;
    }

    .metric-name {
        font-weight: 600;
        color: #333;
        min-width: 100px;
    }

    .metric-value {
        text-align: center;
        color: #667eea;
        font-weight: 700;
        min-width: 80px;
    }

    .metric-diff {
        text-align: center;
        font-size: 0.95em;
        font-weight: 600;
        min-width: 80px;
    }

    .diff-positive {
        color: #10b981;
    }

    .diff-negative {
        color: #ef4444;
    }

    .diff-neutral {
        color: #6b7280;
    }

    .trend-arrow {
        font-size: 1.2em;
        margin-right: 5px;
    }

    .muscle-group-item {
        background: #f9fafb;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
    }

    .muscle-group-item:last-child {
        margin-bottom: 0;
    }

    .muscle-name {
        font-weight: 600;
        color: #333;
    }

    .muscle-diff {
        font-weight: 600;
        min-width: 70px;
        text-align: right;
    }

    .no-data {
        text-align: center;
        color: #999;
        font-style: italic;
        padding: 20px;
    }

    /* Objectives section */
    .objectives-section {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }

    .objectives-title {
        font-size: 0.95em;
        font-weight: 700;
        color: #333;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .objectives-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .objective-item {
        background: #f9fafb;
        border-left: 3px solid #667eea;
        padding: 10px 12px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .objective-item strong {
        color: #333;
        font-weight: 600;
        display: block;
        margin-bottom: 2px;
    }

    .objective-item small {
        color: #999;
        display: block;
        font-size: 0.85em;
    }

    .no-objectives {
        text-align: center;
        color: #bbb;
        font-size: 0.9em;
        font-style: italic;
        padding: 10px;
    }

    /* Marked card styles */
    .athlete-card.marked {
        opacity: 0.6;
    }

    .athlete-card.marked .athlete-header {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    }

    .validation-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(16, 185, 129, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85em;
        font-weight: 600;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .validation-badge:hover {
        background: rgba(16, 185, 129, 1);
        transform: scale(1.05);
        border-color: rgba(255,255,255,0.5);
    }

    .validation-badge .days {
        display: block;
        font-size: 1.1em;
        margin-top: 2px;
    }

    .athlete-card.marked {
        position: relative;
    }

    /* Checkbox wrapper in header */
    .card-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px;
    }

    .card-header-info {
        flex: 1;
    }

    .check-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .check-wrapper input[type="checkbox"] {
        width: 24px;
        height: 24px;
        cursor: pointer;
        accent-color: #667eea;
    }

    .check-label {
        font-size: 0.75em;
        color: white;
        white-space: nowrap;
        font-weight: 600;
    }

    /* Section for marked cards */
    .marked-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 3px solid rgba(255,255,255,0.2);
    }

    .marked-section h2 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 1.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .marked-athletes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
    }

    /* Loading spinner */
    .summary-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 30px;
        gap: 12px;
        color: #667eea;
        font-weight: 600;
    }

    .summary-loader.hidden {
        display: none !important;
    }

    .spinner-small {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-bilan h1 {
            font-size: 1.6em;
        }

        .athletes-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .summary-table {
            font-size: 0.9em;
        }

        .summary-table td {
            padding: 10px 8px;
        }

        .metric-value,
        .metric-diff {
            min-width: auto;
        }
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="bilan-container">
    <!-- Header -->
    <div class="header-bilan">
        <h1>üìä Easy Bilan Hebdo</h1>
        <p>Synth√®se semaine actuelle vs pr√©c√©dente pour chaque athl√®te</p>
    </div>

    <!-- Athletes cards grid -->
    <div class="athletes-grid" id="active-athletes">
    <div class="athletes-grid" id="active-athletes">
        {% for athlete in athletes %}
        <div class="athlete-card" id="athlete-card-{{ athlete.id }}" data-athlete-id="{{ athlete.id }}">
            <div class="athlete-header">
                <div class="card-header-top">
                    <div class="card-header-info">
                        <h2 class="athlete-name">{{ athlete.username }}</h2>
                        <div class="athlete-weeks">
                            Semaine: {{ current_week_start.strftime('%d %b') }} - {{ current_week_end.strftime('%d %b') }}
                        </div>
                    </div>
                    <div class="check-wrapper">
                        <input type="checkbox" class="bilan-checkbox" id="check-{{ athlete.id }}" data-athlete-id="{{ athlete.id }}">
                        <label class="check-label" for="check-{{ athlete.id }}">Bilan fait</label>
                    </div>
                </div>
            </div>

            <div class="athlete-body">
                <div id="variation-{{ athlete.id }}" style="background: #f0f4ff; border-left: 3px solid #667eea; padding: 10px 12px; margin-bottom: 12px; border-radius: 4px; font-size: 0.9em; color: #333; display:none;">
                    <strong>Variation S vs S-1:</strong> <span id="variation-text-{{ athlete.id }}"></span>
                </div>
                <div id="loader-{{ athlete.id }}" class="summary-loader">
                    <div class="spinner-small"></div>
                    <span>Chargement des stats...</span>
                </div>
                <div id="summary-{{ athlete.id }}" class="summary-content" style="display:none;"></div>

                <!-- Objectives section -->
                {% if athlete_objectives.get(athlete.id) %}
                    <div class="objectives-section">
                        <h4 class="objectives-title">üéØ Objectifs</h4>
                        <div class="objectives-list">
                            {% for objective in athlete_objectives[athlete.id][:3] %}
                                <div class="objective-item">
                                    <strong>{{ objective.title }}</strong>
                                    {% if objective.description %}
                                        <small>{{ objective.description[:80] }}{% if objective.description|length > 80 %}...{% endif %}</small>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            {% if athlete_objectives[athlete.id]|length > 3 %}
                                <div class="objective-item" style="text-align: center; font-style: italic; color: #999; border-left-color: #ddd;">
                                    +{{ athlete_objectives[athlete.id]|length - 3 }} objectif(s) de plus
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="objectives-section">
                        <h4 class="objectives-title">üéØ Objectifs</h4>
                        <div class="no-objectives">Aucun objectif pour le moment</div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {% if not athletes %}
        <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
            <p style="font-size: 1.1em;">Aucun athl√®te pour le moment.</p>
        </div>
        {% endif %}
    </div>

    <!-- Section for marked athletes -->
    <div class="marked-section" id="marked-section" style="display:none;">
        <h2>‚úÖ Bilans valid√©s</h2>
        <div class="marked-athletes-grid" id="marked-athletes">
        </div>
    </div>
</div>

<!-- Modal for muscle detail -->
<div id="muscle-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 25px rgba(0,0,0,0.15);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="muscle-detail-title" style="margin:0;">D√©tail par exercice</h3>
      <button onclick="document.getElementById('muscle-detail-modal').style.display='none';" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
    </div>
    <div id="muscle-detail-content" style="color:#333; display:flex; justify-content:center; align-items:center; min-height:100px;">
      <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
        <div style="width:30px; height:30px; border:3px solid #e5e7eb; border-top-color:#667eea; border-radius:50%; animation: spin 1s linear infinite;"></div>
        <span style="color:#94a3b8; font-size:0.9rem;">Chargement des d√©tails...</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal for series detail -->
<div id="series-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1001; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:8px; padding:24px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 25px rgba(0,0,0,0.15);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="series-detail-title" style="margin:0;">D√©tail des s√©ries</h3>
      <button onclick="document.getElementById('series-detail-modal').style.display='none';" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
    </div>
    <div id="series-detail-content" style="color:#333; display:flex; justify-content:center; align-items:center; min-height:100px;">
      <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
        <div style="width:30px; height:30px; border:3px solid #e5e7eb; border-top-color:#667eea; border-radius:50%; animation: spin 1s linear infinite;"></div>
        <span style="color:#94a3b8; font-size:0.9rem;">Chargement des s√©ries...</span>
      </div>
    </div>
  </div>
</div>

<script>
    const athletes = {{ athletes | map(attribute='id') | list | tojson }};
    const weekOffset = {{ week_offset }};

    async function loadAthletesSummary() {
        for (const athleteId of athletes) {
            try {
                const response = await fetch(`/coach/stats/athlete/${athleteId}/summary-7days.json?week_offset=${weekOffset}`);
                const data = await response.json();
                renderSummary(athleteId, data);
            } catch (error) {
                console.error(`Erreur pour athl√®te ${athleteId}:`, error);
                document.getElementById(`summary-${athleteId}`).innerHTML = '<div class="no-data">Erreur de chargement</div>';
                document.getElementById(`loader-${athleteId}`).classList.add('hidden');
                document.getElementById(`summary-${athleteId}`).style.display = 'block';
            }
        }
    }

    function renderSummary(athleteId, data) {
        const container = document.getElementById(`summary-${athleteId}`);
        
        // Show variation section if tonnage_diff data exists
        if (data.summary_7days && data.summary_7days.tonnage_diff_by_muscle) {
            const totalDiff = Object.values(data.summary_7days.tonnage_diff_by_muscle || {}).reduce((a, b) => a + b, 0);
            const variationText = totalDiff > 0 ? `+${totalDiff.toFixed(0)} kg (üìà Augmentation)` : 
                                  (totalDiff < 0 ? `${totalDiff.toFixed(0)} kg (üìâ Diminution)` : '‚Üí Stable');
            document.getElementById(`variation-${athleteId}`).style.display = 'block';
            document.getElementById(`variation-text-${athleteId}`).textContent = variationText;
        }
        
        let html = '<table class="summary-table"><tbody>';

        // Poids
        if (data.weight_current !== null) {
            const trend = getTrendArrow(data.weight_diff);
            const diffClass = getDiffClass(data.weight_diff, 'weight');
            html += `
                <tr>
                    <td class="metric-name">Poids</td>
                    <td class="metric-value">${data.weight_current.toFixed(1)} kg</td>
                    <td class="metric-diff ${diffClass}">
                        ${trend} ${Math.abs(data.weight_diff || 0).toFixed(1)} kg
                    </td>
                </tr>
            `;
        }

        // Kcals
        if (data.kcals_current !== null) {
            const trend = getTrendArrow(data.kcals_diff);
            const diffClass = getDiffClass(data.kcals_diff, 'kcals');
            html += `
                <tr>
                    <td class="metric-name">Kcals</td>
                    <td class="metric-value">${Math.round(data.kcals_current)}</td>
                    <td class="metric-diff ${diffClass}">
                        ${trend} ${Math.abs(Math.round(data.kcals_diff || 0))}
                    </td>
                </tr>
            `;
        }

        // Eau
        if (data.water_current !== null) {
            const trend = getTrendArrow(data.water_diff);
            const diffClass = getDiffClass(data.water_diff, 'water');
            html += `
                <tr>
                    <td class="metric-name">Eau</td>
                    <td class="metric-value">${Math.round(data.water_current)} ml</td>
                    <td class="metric-diff ${diffClass}">
                        ${trend} ${Math.abs(Math.round(data.water_diff || 0))} ml
                    </td>
                </tr>
            `;
        }

        // Sommeil
        if (data.sleep_current !== null) {
            const trend = getTrendArrow(data.sleep_diff);
            const diffClass = getDiffClass(data.sleep_diff, 'sleep');
            html += `
                <tr>
                    <td class="metric-name">Sommeil</td>
                    <td class="metric-value">${data.sleep_current.toFixed(1)} h</td>
                    <td class="metric-diff ${diffClass}">
                        ${trend} ${Math.abs(data.sleep_diff || 0).toFixed(1)} h
                    </td>
                </tr>
            `;
        }

        html += '</tbody></table>';

        // Add 4 comparison tables section
        html += `
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                <h4 style="color: #333; font-size: 0.95em; margin: 0 0 12px 0;">Comparaisons hebdomadaires</h4>
                <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;">
                    <!-- Comparison 1: S vs S-1 -->
                    <div style="background: #f9fafb; border-radius: 6px; padding: 0; border-left: 3px solid #667eea; overflow: hidden; min-width: 280px; flex-shrink: 0;" class="comparison-card" data-table="${athleteId}-1">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f3f4f6;">
                            <h5 style="margin: 0; color: #667eea; font-size: 0.85em; font-weight: 600;">S vs S-1</h5>
                            <button style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 1.2em; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;" class="close-comparison">‚úï</button>
                        </div>
                        <div id="comparison-${athleteId}-1-loader" style="text-align: center; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; border: 2px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #64748b; font-size: 0.8em;">Chargement...</span>
                        </div>
                        <div id="comparison-${athleteId}-1-container" style="display: none; padding: 0 12px 12px 12px; max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <tbody id="comparison-${athleteId}-1-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Comparison 2: S vs S-2 -->
                    <div style="background: #f9fafb; border-radius: 6px; padding: 0; border-left: 3px solid #764ba2; overflow: hidden; min-width: 280px; flex-shrink: 0;" class="comparison-card" data-table="${athleteId}-2">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f3f4f6;">
                            <h5 style="margin: 0; color: #764ba2; font-size: 0.85em; font-weight: 600;">S vs S-2</h5>
                            <button style="background: none; border: none; color: #764ba2; cursor: pointer; font-size: 1.2em; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;" class="close-comparison">‚úï</button>
                        </div>
                        <div id="comparison-${athleteId}-2-loader" style="text-align: center; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; border: 2px solid #e5e7eb; border-top-color: #764ba2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #64748b; font-size: 0.8em;">Chargement...</span>
                        </div>
                        <div id="comparison-${athleteId}-2-container" style="display: none; padding: 0 12px 12px 12px; max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <tbody id="comparison-${athleteId}-2-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Comparison 3: S-1 vs S-2 -->
                    <div style="background: #f9fafb; border-radius: 6px; padding: 0; border-left: 3px solid #667eea; overflow: hidden; min-width: 280px; flex-shrink: 0;" class="comparison-card" data-table="${athleteId}-3">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f3f4f6;">
                            <h5 style="margin: 0; color: #667eea; font-size: 0.85em; font-weight: 600;">S-1 vs S-2</h5>
                            <button style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 1.2em; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;" class="close-comparison">‚úï</button>
                        </div>
                        <div id="comparison-${athleteId}-3-loader" style="text-align: center; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; border: 2px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #64748b; font-size: 0.8em;">Chargement...</span>
                        </div>
                        <div id="comparison-${athleteId}-3-container" style="display: none; padding: 0 12px 12px 12px; max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <tbody id="comparison-${athleteId}-3-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Comparison 4: S-1 vs S-3 -->
                    <div style="background: #f9fafb; border-radius: 6px; padding: 0; border-left: 3px solid #764ba2; overflow: hidden; min-width: 280px; flex-shrink: 0;" class="comparison-card" data-table="${athleteId}-4">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f3f4f6;">
                            <h5 style="margin: 0; color: #764ba2; font-size: 0.85em; font-weight: 600;">S-1 vs S-3</h5>
                            <button style="background: none; border: none; color: #764ba2; cursor: pointer; font-size: 1.2em; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;" class="close-comparison">‚úï</button>
                        </div>
                        <div id="comparison-${athleteId}-4-loader" style="text-align: center; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; border: 2px solid #e5e7eb; border-top-color: #764ba2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #64748b; font-size: 0.8em;">Chargement...</span>
                        </div>
                        <div id="comparison-${athleteId}-4-container" style="display: none; padding: 0 12px 12px 12px; max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <tbody id="comparison-${athleteId}-4-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html || '<div class="no-data">Pas de donn√©es disponibles</div>';
        
        // Hide loader and show content
        document.getElementById(`loader-${athleteId}`).classList.add('hidden');
        container.style.display = 'block';
        
        // Add close button handlers
        const closeButtons = container.querySelectorAll('.close-comparison');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const card = this.closest('.comparison-card');
                card.style.display = 'none';
            });
        });
        
        // Load comparisons for this athlete
        loadComparisonForAthlete(athleteId);
    }

    function getTrendArrow(diff) {
        if (diff === null || diff === undefined) return '‚ûñ';
        if (Math.abs(diff) < 0.1) return '‚û°Ô∏è';
        return diff > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
    }

    function getDiffClass(diff, metric) {
        if (diff === null || diff === undefined || Math.abs(diff) < 0.1) return 'diff-neutral';
        
        // Pour le poids : baisse = bon
        if (metric === 'weight') return diff < 0 ? 'diff-positive' : 'diff-negative';
        // Pour les autres : hausse = bon (g√©n√©ralement)
        return diff > 0 ? 'diff-positive' : 'diff-negative';
    }

    // Checkbox handling
    const checkboxes = document.querySelectorAll('.bilan-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', async (e) => {
            const athleteId = parseInt(e.target.dataset.athleteId);
            const isChecked = e.target.checked;
            
            try {
                const endpoint = isChecked ? 
                    `/coach/bilan-hebdo/mark/${athleteId}` : 
                    `/coach/bilan-hebdo/unmark/${athleteId}`;
                
                const response = await fetch(endpoint, { method: 'POST' });
                
                if (!response.ok) {
                    console.error('Erreur:', response.statusText);
                    e.target.checked = !isChecked;
                    alert('Erreur lors de la mise √† jour');
                    return;
                }
                
                // Update card appearance
                updateCardAppearance(athleteId, isChecked);
                
                // Update navbar badge count
                updateBilanBadgeCount();
            } catch (error) {
                console.error('Erreur:', error);
                e.target.checked = !isChecked;
                alert('Erreur lors de la mise √† jour');
            }
        });
    });

    function updateCardAppearance(athleteId, isMarked, expiresAt = null) {
        const card = document.getElementById(`athlete-card-${athleteId}`);
        const activeGrid = document.getElementById('active-athletes');
        const markedSection = document.getElementById('marked-section');
        const markedGrid = document.getElementById('marked-athletes');
        
        // Remove existing badge if any
        const existingBadge = card.querySelector('.validation-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        if (isMarked) {
            // Move card to marked section
            card.classList.add('marked');
            markedGrid.appendChild(card);
            
            // Add validation badge with days remaining
            const daysRemaining = expiresAt ? calculateDaysRemaining(expiresAt) : 7;
            const badge = document.createElement('div');
            badge.className = 'validation-badge';
            badge.innerHTML = `
                ‚úÖ Valid√©<span class="days">${daysRemaining} j</span>
            `;
            card.style.position = 'relative';
            card.appendChild(badge);
            
            // Add click handler to badge for unmarking
            badge.addEventListener('click', async (e) => {
                e.stopPropagation();
                const checkbox = document.getElementById(`check-${athleteId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
            
            // Show marked section if not visible
            if (markedSection.style.display === 'none') {
                markedSection.style.display = 'block';
            }
        } else {
            // Move card back to active grid
            card.classList.remove('marked');
            activeGrid.appendChild(card);
            
            // Hide marked section if empty
            if (markedGrid.children.length === 0) {
                markedSection.style.display = 'none';
            }
        }
    }

    function calculateDaysRemaining(expiresAt) {
        const now = new Date();
        const expireDate = new Date(expiresAt);
        const diffTime = expireDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.max(0, diffDays);
    }

    // Load and display comparisons for an athlete
    async function loadComparisonForAthlete(athleteId) {
        try {
            const res = await fetch(`/coach/stats/athlete/${athleteId}/quick-data.json`);
            if (!res.ok) return;
            
            const data = await res.json();
            
            if (data.summary_7days) displayComparisonInCard(athleteId, 1, data.summary_7days);
            if (data.summary_14days) displayComparisonInCard(athleteId, 2, data.summary_14days);
            if (data.summary_21days) displayComparisonInCard(athleteId, 3, data.summary_21days);
            if (data.summary_28days) displayComparisonInCard(athleteId, 4, data.summary_28days);
        } catch (err) {
            console.error('Error loading comparisons for athlete', athleteId, err);
        }
    }

    // Display comparison in athlete card
    async function displayComparisonInCard(athleteId, tableNum, data) {
        if (!data) return;
        
        const getArrow = (diff) => {
            if (diff === null || diff === undefined) return '‚Äî';
            if (Math.abs(diff) < 0.1) return '‚Üí';
            return diff > 0 ? 'üìà' : 'üìâ';
        };
        
        const formatValue = (val, decimals = 1) => {
            if (val === null || val === undefined) return '‚Äî';
            return Number(val).toFixed(decimals);
        };
        
        const formatDiff = (val, decimals = 1) => {
            if (val === null || val === undefined) return '‚Äî';
            const num = Number(val).toFixed(decimals);
            const sign = parseFloat(num) > 0 ? '+' : '';
            return sign + num;
        };
        
        const loader = document.getElementById(`comparison-${athleteId}-${tableNum}-loader`);
        const container = document.getElementById(`comparison-${athleteId}-${tableNum}-container`);
        const tbody = document.getElementById(`comparison-${athleteId}-${tableNum}-body`);
        
        if (!tbody) return;
        tbody.innerHTML = '';
        
        // Build header
        const headerHtml = `
            <tr style="background:#f3f4f6; border-bottom:1px solid #d1d5db; font-size:0.7rem;">
                <th style="padding:4px; text-align:left; font-weight:600;">M√©trique</th>
                <th style="padding:4px; text-align:center; font-weight:600; width:60px;">Courant</th>
                <th style="padding:4px; text-align:center; font-weight:600; width:60px;">Pr√©c.</th>
                <th style="padding:4px; text-align:center; font-weight:600; width:50px;">Diff</th>
            </tr>
        `;
        tbody.innerHTML += headerHtml;
        
        // Poids
        let poidsTr = document.createElement('tr');
        poidsTr.style.borderBottom = '1px solid #e5e7eb';
        const poidsArrow = getArrow(data.weight_diff);
        poidsTr.innerHTML = `
            <td style="padding:4px; font-weight:500; font-size:0.7rem;">Poids</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.weight_current, 1)}</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.weight_previous, 1)}</td>
            <td style="padding:4px; text-align:center; font-size:0.65rem;">${formatDiff(data.weight_diff, 1)} ${poidsArrow}</td>
        `;
        tbody.appendChild(poidsTr);
        
        // Kcals
        let kcalsTr = document.createElement('tr');
        kcalsTr.style.borderBottom = '1px solid #e5e7eb';
        const kcalsArrow = getArrow(data.kcals_diff);
        kcalsTr.innerHTML = `
            <td style="padding:4px; font-weight:500; font-size:0.7rem;">Kcals</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.kcals_current, 0)}</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.kcals_previous, 0)}</td>
            <td style="padding:4px; text-align:center; font-size:0.65rem;">${formatDiff(data.kcals_diff, 0)} ${kcalsArrow}</td>
        `;
        tbody.appendChild(kcalsTr);
        
        // Eau
        let eauTr = document.createElement('tr');
        eauTr.style.borderBottom = '1px solid #e5e7eb';
        const eauArrow = getArrow(data.water_diff);
        eauTr.innerHTML = `
            <td style="padding:4px; font-weight:500; font-size:0.7rem;">Eau</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.water_current, 0)}</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.water_previous, 0)}</td>
            <td style="padding:4px; text-align:center; font-size:0.65rem;">${formatDiff(data.water_diff, 0)} ${eauArrow}</td>
        `;
        tbody.appendChild(eauTr);
        
        // Sommeil
        let sommeilTr = document.createElement('tr');
        const sommeilArrow = getArrow(data.sleep_diff);
        sommeilTr.innerHTML = `
            <td style="padding:4px; font-weight:500; font-size:0.7rem;">Sommeil</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.sleep_current, 1)}</td>
            <td style="padding:4px; text-align:center; font-size:0.7rem;">${formatValue(data.sleep_previous, 1)}</td>
            <td style="padding:4px; text-align:center; font-size:0.65rem;">${formatDiff(data.sleep_diff, 1)} ${sommeilArrow}</td>
        `;
        tbody.appendChild(sommeilTr);
        
        // Tonnage by muscle group
        if (data.tonnage_diff_by_muscle && Object.keys(data.tonnage_diff_by_muscle).length > 0) {
            // Add a separator row
            let sepTr = document.createElement('tr');
            sepTr.innerHTML = `<td colspan="5" style="padding:6px 4px;"></td>`;
            tbody.appendChild(sepTr);
            
            // Add tonnage rows with detail buttons
            Object.keys(data.tonnage_diff_by_muscle).sort().forEach(muscle => {
                const diff = data.tonnage_diff_by_muscle[muscle];
                const arrow = getArrow(diff);
                
                let tonTr = document.createElement('tr');
                tonTr.style.borderBottom = '1px solid #e5e7eb';
                tonTr.innerHTML = `
                    <td style="padding:4px; font-weight:500; font-size:0.65rem; color:#666;">${muscle}</td>
                    <td style="padding:4px; text-align:center; font-size:0.7rem;">‚Äî</td>
                    <td style="padding:4px; text-align:center; font-size:0.7rem;">‚Äî</td>
                    <td style="padding:4px; text-align:center; font-size:0.65rem;">${formatDiff(diff, 0)} ${arrow}</td>
                    <td style="padding:4px; text-align:center;"><button class="show-muscle-detail" data-muscle="${muscle}" data-athlete="${athleteId}" data-table="${tableNum}" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.7rem; text-decoration: underline; padding: 0;">D√©tail</button></td>
                `;
                tbody.appendChild(tonTr);
            });
        }
        
        loader.style.display = 'none';
        container.style.display = 'block';
    }

    // Load data when page loads
    async function initPage() {
        // Load markings
        try {
            const response = await fetch('/coach/bilan-hebdo/check-markings');
            const data = await response.json();
            
            // Check marked athletes
            for (const [athleteId, markingData] of Object.entries(data.markings)) {
                const checkbox = document.getElementById(`check-${athleteId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    const expiresAt = markingData.expires_at || null;
                    updateCardAppearance(parseInt(athleteId), true, expiresAt);
                }
            }
            
            // Update navbar badge with count of unmarked athletes
            updateBilanBadgeCount();
        } catch (error) {
            console.error('Erreur lors du chargement des marquages:', error);
        }
        
        // Load athlete data
        await loadAthletesSummary();
    }

    function updateBilanBadgeCount() {
        const uncheckedCount = document.querySelectorAll('.bilan-checkbox:not(:checked)').length;
        if (window.updateBilanBadge) {
            window.updateBilanBadge(uncheckedCount);
        }
    }

    // Cache for muscle details and series
    let exerciseDetailsCache = {};
    let seriesByExerciseCache = {};
    let currentComparisonContext = {};

    // Event delegation for muscle detail buttons
    document.addEventListener('click', function(e) {
        if (e.target.matches('.show-muscle-detail')) {
            const muscle = e.target.getAttribute('data-muscle');
            const athleteId = e.target.getAttribute('data-athlete');
            const tableNum = e.target.getAttribute('data-table');
            
            // Show modal with spinner
            document.getElementById('muscle-detail-modal').style.display = 'flex';
            document.getElementById('muscle-detail-title').textContent = `D√©tail par exercice - ${muscle}`;
            document.getElementById('muscle-detail-content').innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
                    <div style="width:30px; height:30px; border:3px solid #e5e7eb; border-top-color:#667eea; border-radius:50%; animation: spin 1s linear infinite;"></div>
                    <span style="color:#94a3b8; font-size:0.9rem;">Chargement des d√©tails...</span>
                </div>
            `;
            
            // Fetch exercise details from quick-data endpoint
            fetch(`/coach/stats/athlete/${athleteId}/quick-data.json`)
                .then(res => res.json())
                .then(data => {
                    let summaryKey;
                    let labelMap = { '1': '7 jours', '2': '14 jours', '3': '21 jours', '4': '28 jours' };
                    
                    switch(tableNum) {
                        case '1': summaryKey = 'summary_7days'; break;
                        case '2': summaryKey = 'summary_14days'; break;
                        case '3': summaryKey = 'summary_21days'; break;
                        case '4': summaryKey = 'summary_28days'; break;
                    }
                    
                    // Store context for series detail handler
                    currentComparisonContext = {
                        summary: summaryKey,
                        label: labelMap[tableNum]
                    };
                    
                    // Cache series data
                    seriesByExerciseCache = data.series_by_exercise || {};
                    
                    const summary = data[summaryKey];
                    if (!summary || !summary.exercise_details_by_muscle || !summary.exercise_details_by_muscle[muscle]) {
                        document.getElementById('muscle-detail-content').innerHTML = '<p style="color:#ef4444;">Donn√©es non disponibles</p>';
                        return;
                    }

                    const exercisesByMuscle = summary.exercise_details_by_muscle[muscle];
                    
                    // Build detail HTML
                    let html = `<h4 style="margin-top:0;">${muscle}</h4>`;
                    html += '<table style="width:100%; border-collapse:collapse; margin-top:12px; font-size:0.9rem;">';
                    html += `<tr style="background:#f3f4f6; border-bottom:2px solid #d1d5db;">
                        <th style="padding:8px; text-align:left; font-weight:600;">Exercice</th>
                        <th style="padding:8px; text-align:center; font-weight:600; width:90px;">Courant</th>
                        <th style="padding:8px; text-align:center; font-weight:600; width:90px;">Pr√©c√©dent</th>
                        <th style="padding:8px; text-align:center; font-weight:600; width:70px;">Diff</th>
                        <th style="padding:8px; text-align:center; font-weight:600; width:70px;">D√©tail</th>
                    </tr>`;
                    
                    Object.keys(exercisesByMuscle || {}).sort().forEach(exercise => {
                        const exerciseData = exercisesByMuscle[exercise] || {};
                        const current = exerciseData.current || 0;
                        const previous = exerciseData.previous || 0;
                        const diff = exerciseData.diff || 0;
                        const arrow = diff > 0 ? 'üìà' : (diff < 0 ? 'üìâ' : '‚Üí');
                        const diffStr = diff >= 0 ? `+${diff.toFixed(0)}` : `${diff.toFixed(0)}`;
                        
                        html += `<tr style="border-bottom:1px solid #e5e7eb;">
                            <td style="padding:8px;">${exercise}</td>
                            <td style="padding:8px; text-align:center;">${current.toFixed(0)}</td>
                            <td style="padding:8px; text-align:center;">${previous.toFixed(0)}</td>
                            <td style="padding:8px; text-align:center;">${diffStr} ${arrow}</td>
                            <td style="padding:8px; text-align:center;"><button class="show-exercise-series" data-exercise="${exercise}" style="background:none; border:none; color:#667eea; cursor:pointer; font-size:0.75rem; text-decoration:underline; padding:0;">S√©ries</button></td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                    document.getElementById('muscle-detail-content').innerHTML = html;
                })
                .catch(err => {
                    console.error('Error loading exercise details:', err);
                    document.getElementById('muscle-detail-content').innerHTML = '<p style="color:#ef4444;">Erreur de chargement</p>';
                });
        }
    });

    // Event delegation for exercise series detail buttons
    document.addEventListener('click', function(e) {
        if (e.target.matches('.show-exercise-series')) {
            const exercise = e.target.getAttribute('data-exercise');
            
            document.getElementById('series-detail-modal').style.display = 'flex';
            document.getElementById('series-detail-title').textContent = `D√©tail des s√©ries - ${exercise}`;
            document.getElementById('series-detail-content').innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
                    <div style="width:30px; height:30px; border:3px solid #e5e7eb; border-top-color:#667eea; border-radius:50%; animation: spin 1s linear infinite;"></div>
                    <span style="color:#94a3b8; font-size:0.9rem;">Chargement des s√©ries...</span>
                </div>
            `;
            
            // Get series data from cache
            const data = seriesByExerciseCache[exercise];
            
            if (!data || Object.keys(data).length === 0) {
                let html = `<h4 style="margin-top:0;">${exercise}</h4>`;
                html += '<p style="color:#94a3b8;">Aucune s√©rie enregistr√©e</p>';
                document.getElementById('series-detail-content').innerHTML = html;
                return;
            }
            
            // Build series table
            let html = `<h4 style="margin-top:0;">${exercise}</h4>`;
            html += '<table style="width:100%; border-collapse:collapse; margin-top:12px; font-size:0.85rem;">';
            html += `<tr style="background:#f3f4f6; border-bottom:2px solid #d1d5db; position:sticky; top:0;">
                <th style="padding:8px; text-align:left; font-weight:600;">Date</th>
                <th style="padding:8px; text-align:center; font-weight:600; width:60px;">S√©ries</th>
                <th style="padding:8px; text-align:center; font-weight:600; width:60px;">Reps</th>
                <th style="padding:8px; text-align:center; font-weight:600; width:70px;">Poids</th>
                <th style="padding:8px; text-align:center; font-weight:600; width:80px;">Tonnage</th>
            </tr>`;
            
            // Sort dates in reverse order (most recent first)
            const sortedDates = Object.keys(data).sort().reverse();
            
            sortedDates.forEach(date => {
                const series = data[date];
                
                series.forEach((s, idx) => {
                    const reps = s.reps || 0;
                    const weight = s.weight || 0;
                    const tonnage = (reps * weight).toFixed(0);
                    
                    html += `<tr style="border-bottom:1px solid #e5e7eb;">
                        <td style="padding:8px;">${idx === 0 ? date : ''}</td>
                        <td style="padding:8px; text-align:center;">${idx + 1}</td>
                        <td style="padding:8px; text-align:center;">${reps}</td>
                        <td style="padding:8px; text-align:center;">${weight.toFixed(1)} kg</td>
                        <td style="padding:8px; text-align:center; font-weight:600;">${tonnage}</td>
                    </tr>`;
                });
            });
            
            html += '</table>';
            document.getElementById('series-detail-content').innerHTML = html;
        }
    });

    document.addEventListener('DOMContentLoaded', initPage);
</script>

{% endblock %}
