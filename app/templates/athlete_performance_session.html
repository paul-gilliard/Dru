{% extends 'base.html' %}
{% block title %}Séance — {{ program_session.session_name or 'Séance' }}{% endblock %}
{% block content %}
<h2>Séance — {{ program_session.session_name or 'Séance' }}</h2>

<div class="card">
  <h3>{{ ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'][program_session.day_of_week] }}{% if program_session.session_name %} — {{ program_session.session_name }}{% endif %}</h3>
  <p style="margin-bottom:8px;">Exercices proposés :</p>
  <ul style="margin:0; padding-left:20px;">
    {% for ex in session_exercises %}
    <li><strong>{{ ex.name }}</strong> ({{ ex.muscle or 'Auto' }})
      {% set series_list = ex.get_series_list() %}
      {% if series_list %}
        <ul style="margin:4px 0; padding-left:20px; font-size:0.95rem;">
          {% for s in series_list %}
          <li>{{ s.text }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <em style="color:#999; font-size:0.9rem;">Pas de séries renseignées</em>
      {% endif %}
    </li>
    {% endfor %}
  </ul>

  <h4>Ajouter une performance (date par défaut aujourd'hui)</h4>
  <form id="perf-add-form" method="post" action="{{ url_for('athlete_performance_session', session_id=program_session.id) }}">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:12px;">
      <div>
        <label>Date</label>
        <input id="perf-entry-date" name="entry_date" type="date" value="{{ (now().date()|string) }}" required>
      </div>
      
      <div>
        <label>Exercice</label>
        <select id="perf-exercise" name="exercise" required onchange="updateSeriesDropdown()">
          <option value="">— choisir —</option>
          {% for ex in session_exercises %}
          <option value="{{ ex.name }}">{{ ex.name }} ({{ ex.muscle or 'Auto' }})</option>
          {% endfor %}
          <option value="Autre">Autre</option>
        </select>
      </div>
      
      <div>
        <label>Série (numéro)</label>
        <select id="perf-series" name="series_number">
          <option value="">— toutes séries —</option>
        </select>
      </div>
      
      <div>
        <label>Rép (ex: 6.5)</label>
        <input name="reps" type="number" step="0.1" inputmode="decimal" placeholder="6">
      </div>
      
      <div>
        <label>Poids (kg)</label>
        <input name="load" type="number" step="0.5" inputmode="decimal" placeholder="100">
      </div>
      
      <div style="grid-column: 1 / -1;">
        <label>Remarque</label>
        <input name="notes" type="text" placeholder="Notes sur cette série...">
      </div>
    </div>

    <div style="margin-top:12px;">
      <button type="submit" class="save-program-btn">Ajouter</button>
    </div>
  </form>

<script>
    // Stocker les exercices avec leurs séries
    const exercisesData = {
      {% for ex in session_exercises %}
      "{{ ex.name }}": {
        name: "{{ ex.name }}",
        series: [
          {% set series_list = ex.get_series_list() %}
          {% for s in series_list %}
          { number: {{ s.number }}, text: "{{ s.text }}" }{{ "," if not loop.last else "" }}
          {% endfor %}
        ]
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    };
    
    // Stocker les performances existantes pour détecter les doublons
    window.PERF_ENTRIES = {{ perf_entries_json|tojson }};
    
    function updateSeriesDropdown() {
      const exerciseSelect = document.getElementById('perf-exercise');
      const seriesSelect = document.getElementById('perf-series');
      const selectedExercise = exerciseSelect.value;
      
      // Réinitialiser le select des séries
      seriesSelect.innerHTML = '<option value="">— toutes séries —</option>';
      
      if (selectedExercise && exercisesData[selectedExercise]) {
        const series = exercisesData[selectedExercise].series;
        series.forEach(s => {
          const option = document.createElement('option');
          option.value = s.number;
          option.textContent = s.text;
          seriesSelect.appendChild(option);
        });
      }
    }
  </script>
</div>

<div class="card" style="margin-top:12px;">
  <h3>Entrées enregistrées pour cette séance</h3>
  {% if perf_entries %}
  <table id="perf-entries-table">
    <thead><tr><th>Date</th><th>Exercice</th><th>Série</th><th>Rép</th><th>Poids</th><th>Remarque</th><th>Actions</th></tr></thead>
    <tbody>
      {% for p in perf_entries %}
      <tr data-entry-id="{{ p.id }}" data-entry-date="{{ p.entry_date.isoformat() }}">
        <td class="col-date">{{ p.entry_date.strftime('%Y-%m-%d') }}</td>
        <td class="col-exercise">{{ p.exercise }}</td>
        <td class="center col-series">{{ p.series_number or '—' }}</td>
        <td class="center col-reps">{{ p.reps or '' }}</td>
        <td class="center col-load">{{ p.load or '' }}</td>
        <td class="col-notes">{{ p.notes or '' }}</td>
        <td class="col-actions">
          <button type="button" class="edit-perf-btn" data-entry-id="{{ p.id }}">Modifier</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- bouton résumé déplacé ici -->
  <div style="margin-top:12px; display:flex; justify-content:flex-end;">
    <button id="view-summary-btn" type="button" class="secondary">Voir le résumé</button>
  </div>

  {% else %}
    <p class="text-muted">Aucune performance enregistrée pour cette séance.</p>
  {% endif %}
</div>

<!-- Edit modal for performance entry -->
<div id="perf-edit-modal" class="confirm-modal" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document">
    <div class="confirm-modal-body">
      <h3>Modifier performance</h3>
      <form id="perf-edit-form" method="post" action="">
        <input type="hidden" id="edit-entry-id" name="entry_id">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:12px;">
          <div><label>Date</label><input id="edit-entry-date" name="entry_date" type="date" required></div>
          <div><label>Exercice</label><input id="edit-exercise" name="exercise" type="text" required></div>
          <div><label>Série (n°)</label><input id="edit-series-number" name="series_number" type="number" step="1"></div>
          <div><label>Rép</label><input id="edit-reps" name="reps" type="number" step="0.1"></div>
          <div><label>Poids (kg)</label><input id="edit-load" name="load" type="number" step="0.5"></div>
          <div style="grid-column:1 / -1;"><label>Remarque</label><input id="edit-notes" name="notes" type="text"></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button id="perf-edit-save" type="submit" class="save-program-btn">Enregistrer</button>
          <button type="button" id="perf-edit-cancel" class="confirm-no">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/athlete_performance.js') }}"></script>
{% endblock %}