{% extends 'base.html' %}
{% block title %}Programme — {{ athlete.username }}{% endblock %}
{% block content %}
<h2>Programme — {{ athlete.username }}</h2>

<nav style="margin-bottom:12px; display:flex; gap:12px;">
  <a href="{{ url_for('athlete_program') }}" class="kv" {% if request.path == url_for('athlete_program') %}style="font-weight:700;text-decoration:underline"{% endif %}>Programme</a>
  <a href="{{ url_for('athlete_journal') }}" class="kv" {% if request.path.startswith(url_for('athlete_journal')) %}style="font-weight:700;text-decoration:underline"{% endif %}>Journal</a>
  <a href="{{ url_for('athlete_performance') }}" class="kv" {% if request.path.startswith(url_for('athlete_performance')) %}style="font-weight:700;text-decoration:underline"{% endif %}>Entraînement</a>
</nav>

<div class="card" style="margin-bottom:12px;">
  <h3>Programmes</h3>
  {% if programs %}
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      {% for p in programs %}
        <a href="{{ url_for('athlete_program_view', program_id=p.id) }}" class="kv" style="{% if program and program.id==p.id %}font-weight:700;text-decoration:underline{% endif %}">{{ p.name }}</a>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">Aucun programme associé pour le moment.</p>
  {% endif %}
</div>

{% if program %}
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
    <h3 style="margin:0;">{{ program.name }}</h3>
    <span class="session-badge" style="font-size:0.9rem; padding:6px 12px; background:#f3f4f6; color:#0b63d6; border-radius:6px; font-weight:600;">
      {% set active_days = 0 %}
      {% for day in range(7) %}
        {% if sessions_by_day.get(day) and sessions_by_day.get(day).exercises|length > 0 %}
          {% set active_days = active_days + 1 %}
        {% endif %}
      {% endfor %}
      {{ active_days }} séances
    </span>
  </div>

  <!-- Program summary -->
  <div style="padding:14px; background:#f9fafb; border-left:4px solid #0b63d6; border-radius:6px; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:14px;">
      {% set all_exercises = [] %}
      {% set all_series = [] %}
      {% set muscle_counts = {} %}
      
      {% for day in range(7) %}
        {% set sd = sessions_by_day.get(day) %}
        {% if sd and sd.exercises %}
          {% for ex in sd.exercises %}
            {% set _ = all_exercises.append(ex) %}
            {% set series_list = ex.get_series_list() %}
            {% for s in series_list %}
              {% set _ = all_series.append(s) %}
            {% endfor %}
            {% if ex.muscle %}
              {% if ex.muscle not in muscle_counts %}
                {% set _ = muscle_counts.update({ex.muscle: []}) %}
              {% endif %}
              {% set _ = muscle_counts[ex.muscle].append(ex) %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      <div>
        <div style="font-size:2rem; font-weight:700; color:#0b63d6;">{{ all_exercises|length }}</div>
        <div style="font-size:0.85rem; color:#666; font-weight:500;">Exercices</div>
      </div>
      <div>
        <div style="font-size:2rem; font-weight:700; color:#0b63d6;">{{ all_series|length }}</div>
        <div style="font-size:0.85rem; color:#666; font-weight:500;">Séries totales</div>
      </div>
      {% for muscle, exs in muscle_counts.items() %}
      <div>
        <div style="font-size:1.3rem; font-weight:700; color:#0b63d6;">
          {% set muscle_series = 0 %}
          {% for e in exs %}
            {% set muscle_series = muscle_series + (e.get_series_list()|length) %}
          {% endfor %}
          {{ muscle_series }}
        </div>
        <div style="font-size:0.85rem; color:#666; font-weight:500;">{{ muscle }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <h3 style="margin-bottom:12px; color:#0b63d6; font-size:1rem;">Semaine d'entraînement</h3>

  <div class="program-days-list" style="margin-top:12px; display:grid; gap:12px;">
    {% for day in range(7) %}
    {% set sd = sessions_by_day.get(day) %}
    <div class="program-day-card" style="border:1px solid rgba(15,23,42,0.1); border-radius:8px; overflow:hidden;">
      <div class="program-day-header" style="padding:12px; background:#f3f4f6; border-bottom:1px solid rgba(15,23,42,0.1);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <strong class="day-name" style="font-size:1rem; color:#0b63d6;">{{ ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'][day] }}</strong>
            {% if sd and sd.session and sd.session.session_name %}
              <span style="color:#666; font-size:0.9rem;"> — {{ sd.session.session_name }}</span>
            {% endif %}
          </div>
          <div style="text-align:right;">
            {% if sd and sd.exercises and sd.exercises|length > 0 %}
              <span style="font-weight:600; color:#0b63d6;">{{ sd.exercises|length }} exercice{{ 's' if sd.exercises|length > 1 else '' }}</span>
            {% else %}
              <span style="color:#999; font-style:italic; font-size:0.9rem;">Repos</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="program-day-body" style="padding:12px;">
        {% if sd and sd.exercises and sd.exercises|length > 0 %}
        <div style="display:flex; flex-direction:column; gap:10px;">
          {% for e in sd.exercises %}
          <div style="padding:10px; background:#f9fafb; border-left:3px solid #0b63d6; border-radius:4px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
              <div>
                <strong style="font-size:0.95rem; color:#0b63d6;">{{ e.name }}</strong>
                {% if e.muscle %}
                  <span style="color:#666; font-size:0.85rem; margin-left:8px;">{{ e.muscle }}</span>
                {% endif %}
              </div>
              {% set series_count = e.get_series_list()|length %}
              <span style="background:#0b63d6; color:white; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:600;">{{ series_count }}S</span>
            </div>
            {% set series_list = e.get_series_list() %}
            {% if series_list %}
              <div style="font-size:0.85rem; color:#666; margin-top:6px;">
                {% for s in series_list %}
                  <div>{{ s.text }}</div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
          <p style="color:#999; font-style:italic; text-align:center; margin:0;">Pas de séance programmée</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% else %}
<div class="card">
  <p class="text-muted">Aucun programme sélectionné.</p>
</div>
{% endif %}

{% endblock %}