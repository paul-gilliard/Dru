{% extends 'base.html' %}
{% block title %}Éditer programme — {{ program.name }}{% endblock %}
{% block content %}
<h2 style="margin-bottom: 20px;">Éditer : {{ program.name }} — {{ program.athlete.username }}</h2>

<div class="card programming-edit-root">
  <!-- form id important pour soumission depuis les boutons flottants -->
  <form id="program-form" method="post" action="{{ url_for('coach_programming_edit', program_id=program.id) }}">
    {# Affichage vertical : chaque jour sur sa ligne #}
    <div class="programming-edit" style="display:flex; flex-direction:column; gap:16px;">
      {% for day in range(7) %}
      <div class="card day-row">
        <h4 style="margin-bottom:12px; color:#0b63d6; font-size:1.1rem;">{{ ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'][day] }}</h4>
        <div class="form-row-horizontal">
          <div class="form-group-inline">
            <label>Nom de la séance</label>
            <input type="text" name="session_name_{{ day }}" value="{{ sessions_by_day[day].session_name if sessions_by_day[day] else '' }}" placeholder="Ex: Jambes">
          </div>
        </div>

        <div style="margin-top:14px;">
          <h5 style="margin-bottom:12px; color:#374151;">{{ ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'][day] }}</h5>
          <div class="exercises-container" id="exercises_day_{{ day }}" style="display:flex; flex-direction:column; gap:20px;">
            {% if sessions_by_day[day] %}
              {% for ex in sessions_by_day[day].exercises %}
              <div class="exercise-block" data-exercise-id="{{ ex.id }}" data-day="{{ day }}" style="border:1px solid rgba(15,23,42,0.1); border-radius:10px; padding:14px; background:#f9fafb;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <div style="flex:1;">
                    <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Exercice</label>
                    <select name="ex_name_{{ day }}[]" class="exercise-select" data-value="{{ ex.name or '' }}" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem;" required><option>-- Sélectionner --</option></select>
                  </div>
                  <div style="margin-left:12px;">
                    <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Muscle</label>
                    <div class="exercise-muscle" style="padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem; background:#f3f4f6; min-width:100px; text-align:center;">{{ ex.muscle or '—' }}</div>
                  </div>
                  <button type="button" class="delete-exercise btn-remove" style="margin-top:20px; background:#ef4444; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600;">Supprimer</button>
                </div>

                <!-- Séries pour cet exercice -->
                <div class="series-list" style="margin-bottom:12px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="font-weight:600; color:#374151; font-size:0.95rem;">Séries</label>
                    <button type="button" class="add-series" data-exercise-id="{{ ex.id }}" data-day="{{ day }}" style="background:#0b63d6; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:0.9rem; font-weight:600;">+ Ajouter série</button>
                  </div>

                  <div class="series-items" style="display:flex; flex-direction:column; gap:8px;">
                    {% set series_list = ex.get_series_list() %}
                    {% if series_list %}
                      {% for s in series_list %}
                      <div class="series-row" style="display:grid; grid-template-columns: 60px 80px 80px 60px auto; gap:8px; align-items:center;" data-series-description="{{ s.description }}" data-series-number="{{ s.number }}" data-is-main="{{ s.is_main|lower }}">
                        <div><label style="font-size:0.85rem; color:#666;">S{{ s.number }}</label></div>
                        <div><input type="text" placeholder="Reps" value="" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
                        <div><input type="number" placeholder="Rest (min)" value="" step="0.1" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
                        <div><input type="number" placeholder="RIR" value="" step="0.5" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
                        <div style="display:flex; align-items:center; gap:4px; justify-content:flex-end;">
                          <input type="checkbox" class="series-main-checkbox" style="width:18px; height:18px; cursor:pointer;" {% if s.is_main %}checked{% endif %}>
                          <label style="font-size:0.85rem; color:#666; cursor:pointer; user-select:none;">P*</label>
                          <button type="button" class="delete-series" style="background:#ef4444; color:white; padding:6px 10px; border-radius:4px; border:none; cursor:pointer; font-size:0.85rem; font-weight:600;">✕</button>
                        </div>
                      </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                  <div style="margin-top:8px; font-size:0.8rem; color:#666;">* = Principale: la série dont on suivra très précisément l'évolution dans les stats</div>
                </div>

                <!-- Remarque générale -->
                <div>
                  <label style="font-size:0.9rem; font-weight:600; color:#374151;">Remarque générale</label>
                  <textarea name="ex_rem_{{ day }}[]" placeholder="Notes..." style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.9rem; min-height:60px; resize:vertical;">{{ ex.remark }}</textarea>
                </div>
              </div>
              {% endfor %}
            {% endif %}
          </div>

          <div style="margin-top:12px;">
            <button type="button" class="add-exercise btn-add-exercise" data-day="{{ day }}" style="background:#0b63d6; color:white; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:700; font-size:0.95rem;">+ Ajouter un exercice</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>
</div>

<!-- Floating actions (always visible left) -->
<div class="floating-actions" aria-hidden="false">
  <button id="save-float" class="save-program-btn" title="Enregistrer le programme">Enregistrer</button>
  <button id="cancel-float" class="cancel-btn" data-return-url="{{ url_for('coach_programming') }}" title="Ne pas enregistrer">Annuler</button>
  <button id="recap-float" class="secondary" title="Voir le récapitulatif">Voir recap</button>
</div>

<!-- Confirmation modal (hidden by default) -->
<div id="confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document">
    <div class="confirm-modal-body">
      <p id="confirm-message">Confirmez votre action</p>
    </div>
    <div class="confirm-modal-actions">
      <button id="confirm-yes" class="confirm-yes">Confirmer</button>
      <button id="confirm-no" class="confirm-no">Annuler</button>
    </div>
  </div>
</div>

<!-- Recap modal -->
<div id="recap-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div class="confirm-modal-body">
      <h3>Récapitulatif du programme</h3>
      <div id="recap-content" style="margin-top: 16px;"></div>
    </div>
    <div class="confirm-modal-actions">
      <button id="recap-close" class="confirm-no">Fermer</button>
    </div>
  </div>
</div>

<!-- Row template hidden -->
<table style="display:none;">
  <tbody id="row-template">
    <tr>
      <td><select name="__NAME__" class="exercise-select" data-value=""><option>-- Sélectionner --</option></select></td>
      <td><input type="text" name="__MUSC__" value="" placeholder="Pecs" style="font-size:1rem; padding:8px;"></td>
      <td><textarea name="__SERIES__" placeholder="S1: 8 reps 100kg&#10;S2: 6 reps 120kg&#10;S3: 4 reps 140kg" style="font-size:0.95rem; padding:8px; min-height:100px; resize:vertical; font-family:monospace;"></textarea></td>
      <td><textarea name="__REM__" placeholder="Notes..." style="font-size:0.95rem; padding:8px; min-height:100px; resize:vertical;"></textarea></td>
      <td><button type="button" class="remove-row btn-remove">✕</button></td>
    </tr>
  </tbody>
</table>

<!-- Exercise and series templates (hidden) -->
<template id="exercise-template">
  <div class="exercise-block" style="border:1px solid rgba(15,23,42,0.1); border-radius:10px; padding:14px; background:#f9fafb;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <div style="flex:1;">
        <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Exercice</label>
        <select name="__EX_NAME__" class="exercise-select" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem;" required><option>-- Sélectionner --</option></select>
      </div>
      <div style="margin-left:12px;">
        <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Muscle</label>
        <div class="exercise-muscle" style="padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem; background:#f3f4f6; min-width:100px; text-align:center;">—</div>
      </div>
      <button type="button" class="delete-exercise" style="margin-top:20px; background:#ef4444; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600;">Supprimer</button>
    </div>

    <div class="series-list" style="margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <label style="font-weight:600; color:#374151; font-size:0.95rem;">Séries</label>
        <button type="button" class="add-series" style="background:#0b63d6; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:0.9rem; font-weight:600;">+ Ajouter série</button>
      </div>
      <div class="series-items" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>

    <div>
      <label style="font-size:0.9rem; font-weight:600; color:#374151;">Remarque générale</label>
      <textarea name="__EX_REM__" placeholder="Notes..." style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.9rem; min-height:60px; resize:vertical;"></textarea>
    </div>
  </div>
</template>

<template id="series-template">
  <div class="series-row" style="display:grid; grid-template-columns: 60px 80px 80px 60px auto; gap:8px; align-items:center;">
    <div><label style="font-size:0.85rem; color:#666;" class="series-number">S1</label></div>
    <div><input type="text" name="__SERIES_REPS__" placeholder="Reps" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
    <div><input type="number" name="__SERIES_REST__" placeholder="Rest (min)" step="0.1" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
    <div><input type="number" name="__SERIES_RIR__" placeholder="RIR" step="0.5" style="width:100%; padding:6px; font-size:0.9rem; border-radius:4px; border:1px solid rgba(15,23,42,0.1);"></div>
    <div style="display:flex; align-items:center; gap:4px; justify-content:flex-end;">
      <input type="checkbox" class="series-main-checkbox" style="width:18px; height:18px; cursor:pointer;">
      <label style="font-size:0.85rem; color:#666; cursor:pointer; user-select:none;">P*</label>
      <button type="button" class="delete-series" style="background:#ef4444; color:white; padding:6px 10px; border-radius:4px; border:none; cursor:pointer; font-size:0.85rem; font-weight:600;">✕</button>
    </div>
  </div>
</template>


<script src="{{ url_for('static', filename='js/programming.js') }}"></script>
{% endblock %}