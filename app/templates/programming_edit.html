{% extends 'base.html' %}
{% block title %}Ã‰diter programme â€” {{ program.name }}{% endblock %}
{% block content %}
<style>
  .programming-edit {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
  }

  .day-row {
    min-height: 200px;
    display: flex;
    flex-direction: column;
  }

  .day-row h4 {
    font-size: 1rem !important;
    margin-bottom: 8px !important;
  }

  @media (max-width: 1200px) {
    .programming-edit {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }

  @media (max-width: 768px) {
    .programming-edit {
      grid-template-columns: 1fr !important;
    }
  }

  .programming-edit-root {
    padding: 20px !important;
  }

  .day-row {
    padding: 16px !important;
    border-left: 4px solid #0b63d6;
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
  }

  .day-row h5 {
    display: none;
  }

  .exercises-container {
    gap: 10px !important;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .exercise-block {
    cursor: grab;
    transition: all 0.3s ease;
    border: 1px solid rgba(11, 99, 214, 0.15) !important;
    border-radius: 8px !important;
    padding: 8px !important;
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%) !important;
    display: flex !important;
    gap: 8px !important;
    position: relative;
    align-items: flex-start;
    flex-wrap: nowrap;
    overflow-x: auto;
    scroll-behavior: smooth;
  }
  
  .exercise-block:hover {
    background: linear-gradient(135deg, #f0f6ff 0%, #f9fafb 100%) !important;
    border-color: rgba(11, 99, 214, 0.35) !important;
    box-shadow: 0 3px 12px rgba(11, 99, 214, 0.12) !important;
  }
  
  .exercise-block.dragging {
    opacity: 0.5;
    cursor: grabbing;
    background: linear-gradient(135deg, #e0e7ff 0%, #e8ebff 100%) !important;
  }
  
  .exercise-block.drag-over {
    background: linear-gradient(135deg, #dbeafe 0%, #e8ebff 100%) !important;
    border: 2px solid #0b63d6 !important;
  }
  
  .exercise-block.collapsed {
    padding: 6px 8px !important;
    gap: 6px !important;
    align-items: center !important;
  }

  .drag-handle {
    cursor: grab;
    color: #cbd5e1;
    font-size: 0.9rem;
    margin-right: 0;
    flex-shrink: 0;
    align-self: center;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .drag-handle:hover {
    color: #0b63d6;
    background: rgba(11, 99, 214, 0.1);
  }

  .exercise-header {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    min-width: 0;
  }

  .exercise-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 700;
    flex-shrink: 0;
    min-width: 45px;
    text-align: center;
  }

  .exercise-badge.muscle {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  }

  .exercise-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex-shrink: 0;
    min-width: 120px;
  }

  .exercise-name {
    font-weight: 700;
    color: #0b63d6;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .exercise-meta {
    font-size: 0.7rem;
    color: #999;
  }
  
  .exercise-details {
    display: flex;
    gap: 6px;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .exercise-block.collapsed .exercise-details {
    display: none !important;
  }
  
  .exercise-header-expanded {
    display: flex;
    gap: 6px;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .exercise-block.collapsed .exercise-header-expanded {
    display: none !important;
  }

  .exercise-header-expanded > div {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
  }

  .exercise-header-expanded label {
    font-size: 0.7rem !important;
    font-weight: 600 !important;
    color: #0b63d6 !important;
    margin-bottom: 0 !important;
  }

  .exercise-header-expanded select,
  .exercise-header-expanded input {
    font-size: 0.8rem !important;
    padding: 4px 6px !important;
    min-width: 100px;
  }

  .series-list {
    margin: 0 !important;
    padding: 0;
    display: flex;
    gap: 6px;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .series-list > div:first-child {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .series-list > div:first-child label {
    font-weight: 600 !important;
    color: #374151 !important;
    font-size: 0.7rem !important;
    margin-bottom: 0 !important;
  }

  .series-items {
    display: flex !important;
    gap: 4px !important;
    flex-wrap: nowrap;
  }

  .series-row {
    padding: 4px !important;
    gap: 3px !important;
    grid-template-columns: 25px 0.6fr 0.6fr 0.6fr 60px !important;
    font-size: 0.75rem !important;
    border: 1px solid rgba(15,23,42,0.1) !important;
    border-radius: 4px !important;
    flex-shrink: 0;
    white-space: nowrap;
  }

  .series-row input {
    padding: 3px 4px !important;
    font-size: 0.75rem !important;
    min-width: 50px;
  }

  .series-row label {
    font-size: 0.65rem !important;
    margin-bottom: 0 !important;
  }

  .add-series {
    padding: 3px 6px !important;
    font-size: 0.7rem !important;
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%) !important;
    color: white !important;
    border-radius: 4px !important;
    flex-shrink: 0;
  }

  .delete-exercise, .delete-series {
    padding: 3px 5px !important;
    font-size: 0.65rem !important;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    color: white !important;
    border-radius: 3px !important;
    flex-shrink: 0;
  }

  textarea[name*="ex_rem_"] {
    font-size: 0.75rem !important;
    min-height: 35px !important;
    padding: 4px !important;
    min-width: 150px;
    flex-shrink: 0;
  }

  .toggle-collapse {
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%);
    color: white;
    border: none;
    padding: 4px 7px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: 700;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 24px;
  }
  
  .toggle-collapse:hover {
    background: linear-gradient(135deg, #0952b8 0%, #0741a0 100%);
    box-shadow: 0 2px 6px rgba(11, 99, 214, 0.3);
  }

  .exercise-muscle {
    font-size: 0.75rem !important;
    padding: 3px 6px !important;
    text-align: center !important;
  }

  .exercise-name-display {
    display: none;
    font-weight: 600;
    color: #0b63d6;
    flex: 1;
    padding-left: 4px;
    font-size: 0.85rem;
  }
  }
  
  .toggle-collapse {
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%);
    color: white;
    border: none;
    padding: 5px 9px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 700;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 28px;
  }
  
  .toggle-collapse:hover {
    background: linear-gradient(135deg, #0952b8 0%, #0741a0 100%);
    box-shadow: 0 2px 6px rgba(11, 99, 214, 0.3);
  }

  .exercise-muscle {
    font-size: 0.85rem !important;
    padding: 6px 10px !important;
  }

  .series-row {
    padding: 8px !important;
    gap: 6px !important;
    grid-template-columns: 40px 1fr 1fr 1fr 90px !important;
    font-size: 0.9rem;
  }

  .series-row input {
    padding: 6px 8px !important;
    font-size: 0.85rem !important;
  }

  .series-row label {
    font-size: 0.75rem !important;
    margin-bottom: 0 !important;
  }

  .series-list {
    margin-bottom: 10px !important;
  }

  .series-list label:first-of-type {
    font-size: 0.9rem !important;
    font-weight: 600 !important;
  }

  .add-series {
    padding: 5px 10px !important;
    font-size: 0.8rem !important;
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%) !important;
    color: white !important;
    border-radius: 5px !important;
  }

  .delete-exercise, .delete-series {
    padding: 5px 8px !important;
    font-size: 0.75rem !important;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    color: white !important;
    border-radius: 4px !important;
  }

  .delete-exercise:hover, .delete-series:hover {
    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3) !important;
  }

  .form-row-horizontal {
    display: flex;
    gap: 12px;
    margin-bottom: 10px;
  }

  .form-group-inline {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-group-inline label {
    font-size: 0.85rem;
    font-weight: 600;
  }

  .form-group-inline input {
    font-size: 0.9rem;
    padding: 6px 8px;
  }

  textarea[name*="ex_rem_"] {
    font-size: 0.85rem !important;
    min-height: 50px !important;
    padding: 8px !important;
  }

  .add-exercise {
    background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%) !important;
    color: white !important;
    padding: 8px 14px !important;
    font-size: 0.9rem !important;
    border-radius: 6px !important;
    margin-top: 8px;
  }

  .add-exercise:hover {
    box-shadow: 0 4px 12px rgba(11, 99, 214, 0.2) !important;
  }

  .series-number {
    margin-bottom: 0 !important;
  }
</style>

<div style="margin-bottom: 16px; display: flex; gap: 8px; align-items: center;">
  <h2 style="margin: 0; font-size: 1.3rem;">{{ program.name }} <span style="font-size: 0.9rem; color: #666;">â€” {{ program.athlete.username }}</span></h2>
  <div style="margin-left: auto; display: flex; gap: 8px;">
    <button id="collapse-all-btn" type="button" style="background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%); color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem;">âˆ’ Tout rÃ©duire</button>
    <button id="expand-all-btn" type="button" style="background: linear-gradient(135deg, #666 0%, #555 100%); color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem;">+ Tout agrandir</button>
  </div>
</div>

<div class="card programming-edit-root">
  <!-- form id important pour soumission depuis les boutons flottants -->
  <form id="program-form" method="post" action="{{ url_for('coach_programming_edit', program_id=program.id) }}">
    {# Affichage vertical : chaque jour sur sa ligne #}
    <div class="programming-edit" style="display:flex; flex-direction:column; gap:16px;">
      {% for day in range(7) %}
      <div class="card day-row">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <h4 style="margin: 0; color: #0b63d6; font-size: 1rem;">{{ ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'][day] }}</h4>
          <input type="text" name="session_name_{{ day }}" value="{{ sessions_by_day[day].session_name if sessions_by_day[day] else '' }}" placeholder="Nom sÃ©ance" style="flex: 1; max-width: 200px; font-size: 0.9rem; padding: 6px 8px;">
        </div>

        <div class="exercises-container" id="exercises_day_{{ day }}" style="display:flex; flex-direction:column; gap:10px;">
          {% if sessions_by_day[day] %}
            {% for ex in sessions_by_day[day].exercises %}
            <div class="exercise-block" data-exercise-id="{{ ex.id }}" data-day="{{ day }}" draggable="true">
              <div class="drag-handle" title="Glisser pour rÃ©organiser">â‰¡</div>
              
              <div class="exercise-header">
                <div class="exercise-badge">{{ ex.series_count or 0 }}S</div>
                <div class="exercise-info">
                  <div class="exercise-name">{{ ex.name or 'â€”' }}</div>
                  <div class="exercise-meta">{{ ex.muscle or 'N/A' }}</div>
                </div>
              </div>
              
              <button type="button" class="toggle-collapse" title="RÃ©duire/Agrandir">âˆ’</button>
              
              <div class="exercise-details">
                <div class="exercise-header-expanded">
                  <div>
                    <label>Exercice</label>
                    <select name="ex_name_{{ day }}[]" class="exercise-select" data-value="{{ ex.name or '' }}" required><option>-- SÃ©lectionner --</option></select>
                  </div>
                  <div>
                    <label>Muscle</label>
                    <div class="exercise-muscle" style="background:#f3f4f6;">{{ ex.muscle or 'â€”' }}</div>
                  </div>
                  <button type="button" class="delete-exercise btn-remove">Suppr.</button>
                </div>

                <!-- SÃ©ries pour cet exercice -->
                <div class="series-list">
                  <div>
                    <label>SÃ©ries</label>
                    <button type="button" class="add-series" data-exercise-id="{{ ex.id }}" data-day="{{ day }}">+ Ajouter</button>
                  </div>

                  <div class="series-items">
                    {% set series_list = ex.get_series_list() %}
                    {% if series_list %}
                      {% for s in series_list %}
                      <div class="series-row" data-series-description="{{ s.description }}" data-series-number="{{ s.number }}" data-is-main="{{ s.is_main|lower }}">
                        <div><label class="series-number">S{{ s.number }}</label></div>
                        <div><input type="text" placeholder="Reps" value=""></div>
                        <div><input type="number" placeholder="Rest (min)" value="" step="0.1"></div>
                        <div><input type="number" placeholder="RIR" value="" step="0.5"></div>
                        <div style="display:flex; align-items:center; gap:3px; justify-content:flex-end;">
                          <input type="checkbox" class="series-main-checkbox" {% if s.is_main %}checked{% endif %}>
                          <label style="font-size:0.65rem; color:#0b63d6; cursor:pointer; user-select:none; font-weight:600; white-space:nowrap;">P*</label>
                          <button type="button" class="delete-series">âœ•</button>
                        </div>
                      </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>

                <!-- Remarque gÃ©nÃ©rale -->
                <div>
                  <label>Notes</label>
                  <textarea name="ex_rem_{{ day }}[]" placeholder="Remarques...">{{ ex.remark }}</textarea>
                </div>
              </div>
            </div>
            {% endfor %}
          {% endif %}
        </div>

        <div style="margin-top:8px;">
          <button type="button" class="add-exercise btn-add-exercise" data-day="{{ day }}" style="background: linear-gradient(135deg, #0b63d6 0%, #0952b8 100%); color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; font-size:0.85rem;">+ Ajouter exercice</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>
</div>

<!-- Floating actions (always visible left) -->
<div class="floating-actions" aria-hidden="false">
  <button id="save-float" class="save-program-btn" title="Enregistrer le programme" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">âœ“ Enregistrer</button>
  <button id="cancel-float" class="cancel-btn" data-return-url="{{ url_for('coach_programming') }}" title="Ne pas enregistrer" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);">âœ• Annuler</button>
  <button id="recap-float" class="secondary" title="Voir le rÃ©capitulatif" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);">ðŸ“‹ Recap</button>
</div>

<!-- Confirmation modal (hidden by default) -->
<div id="confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document">
    <div class="confirm-modal-body">
      <p id="confirm-message">Confirmez votre action</p>
    </div>
    <div class="confirm-modal-actions">
      <button id="confirm-yes" class="confirm-yes">Confirmer</button>
      <button id="confirm-no" class="confirm-no">Annuler</button>
    </div>
  </div>
</div>

<!-- Recap modal -->
<div id="recap-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div class="confirm-modal-body">
      <h3>RÃ©capitulatif du programme</h3>
      <div id="recap-content" style="margin-top: 16px;"></div>
    </div>
    <div class="confirm-modal-actions">
      <button id="recap-close" class="confirm-no">Fermer</button>
    </div>
  </div>
</div>

<!-- Row template hidden -->
<table style="display:none;">
  <tbody id="row-template">
    <tr>
      <td><select name="__NAME__" class="exercise-select" data-value=""><option>-- SÃ©lectionner --</option></select></td>
      <td><input type="text" name="__MUSC__" value="" placeholder="Pecs" style="font-size:1rem; padding:8px;"></td>
      <td><textarea name="__SERIES__" placeholder="S1: 8 reps 100kg&#10;S2: 6 reps 120kg&#10;S3: 4 reps 140kg" style="font-size:0.95rem; padding:8px; min-height:100px; resize:vertical; font-family:monospace;"></textarea></td>
      <td><textarea name="__REM__" placeholder="Notes..." style="font-size:0.95rem; padding:8px; min-height:100px; resize:vertical;"></textarea></td>
      <td><button type="button" class="remove-row btn-remove">âœ•</button></td>
    </tr>
  </tbody>
</table>

<!-- Exercise and series templates (hidden) -->
<template id="exercise-template">
  <div class="exercise-block" draggable="true" style="border:1px solid rgba(15,23,42,0.1); border-radius:10px; padding:14px; background:#f9fafb; display:flex; gap:12px;">
    <div class="drag-handle" title="Glisser pour rÃ©organiser">â‹®â‹®</div>
    <div class="exercise-name-display">â€”</div>
    <button type="button" class="toggle-collapse" title="RÃ©duire/Agrandir">âˆ’</button>
    
    <div class="exercise-details" style="flex: 1;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div style="flex:1;">
          <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Exercice</label>
          <select name="__EX_NAME__" class="exercise-select" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem;" required><option>-- SÃ©lectionner --</option></select>
        </div>
        <div style="margin-left:12px;">
          <label style="font-size:0.95rem; font-weight:600; color:#0b63d6;">Muscle</label>
          <div class="exercise-muscle" style="padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.95rem; background:#f3f4f6; min-width:100px; text-align:center;">â€”</div>
        </div>
        <button type="button" class="delete-exercise" style="margin-top:20px; background:#ef4444; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600;">Supprimer</button>
      </div>

      <div class="series-list" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <label style="font-weight:600; color:#374151; font-size:0.95rem;">SÃ©ries</label>
          <button type="button" class="add-series" style="background:#0b63d6; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:0.9rem; font-weight:600;">+ Ajouter sÃ©rie</button>
      </div>
        <div class="series-items" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>

      <div>
        <label style="font-size:0.9rem; font-weight:600; color:#374151;">Remarque gÃ©nÃ©rale</label>
        <textarea name="__EX_REM__" placeholder="Notes..." style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(15,23,42,0.1); font-size:0.9rem; min-height:60px; resize:vertical;"></textarea>
      </div>
    </div>
  </div>
</template>

<template id="series-template">
  <div class="series-row" style="display:grid; grid-template-columns: 60px 1fr 1fr 1fr 120px; gap:8px; align-items:center; padding:8px; background:#ffffff; border:1px solid rgba(15,23,42,0.1); border-radius:6px;">
    <div><label style="font-size:0.85rem; color:#666; font-weight:600;" class="series-number">S1</label></div>
    <div><input type="text" name="__SERIES_REPS__" placeholder="Reps" style="width:100%; padding:8px; font-size:0.95rem; border-radius:4px; border:1px solid rgba(15,23,42,0.15); font-weight:500;"></div>
    <div><input type="number" name="__SERIES_REST__" placeholder="Rest (min)" step="0.1" style="width:100%; padding:8px; font-size:0.95rem; border-radius:4px; border:1px solid rgba(15,23,42,0.15); font-weight:500;"></div>
    <div><input type="number" name="__SERIES_RIR__" placeholder="RIR" step="0.5" style="width:100%; padding:8px; font-size:0.95rem; border-radius:4px; border:1px solid rgba(15,23,42,0.15); font-weight:500;"></div>
    <div style="display:flex; align-items:center; gap:6px; justify-content:flex-end;">
      <input type="checkbox" class="series-main-checkbox" style="width:20px; height:20px; cursor:pointer;">
      <label style="font-size:0.85rem; color:#0b63d6; cursor:pointer; user-select:none; font-weight:600; white-space:nowrap;">P*</label>
      <button type="button" class="delete-series" style="background:#ef4444; color:white; padding:6px 10px; border-radius:4px; border:none; cursor:pointer; font-size:0.8rem; font-weight:600;">âœ•</button>
    </div>
  </div>
</template>


<script src="{{ url_for('static', filename='js/programming.js') }}"></script>
<script>
  // Collapse all exercises by default on page load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      const collapseBtn = document.getElementById('collapse-all-btn');
      if (collapseBtn) {
        collapseBtn.click();
      }
    }, 100);
  });
</script>
{% endblock %}