{% extends 'base.html' %}
{% block title %}Suivi statistiques{% endblock %}
{% block content %}
<style>
  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #e5e7eb;
    border-top-color: #0b63d6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  /* Hide loaders initially until athlete is selected */
  .loading-container {
    display: none;
    align-items: center;
    justify-content: center;
    padding: 30px;
    gap: 12px;
    color: #64748b;
  }

  .loading-container.show {
    display: flex !important;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

</style>

<h2>Suivi statistiques</h2>

<!-- {% include 'coach_nav.html' %} -->

<!-- Top row: Selection + Summary -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
  
  <div class="card">
    <h3>Sélection athlete</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <select id="stats-athlete-select">
        <option value="">— choisir un athlete —</option>
        {% for a in athletes %}
        <option value="{{ a.id }}">{{ a.username }}</option>
        {% endfor %}
      </select>

      <label style="display:flex; align-items:center; gap:8px; margin-left:12px;">
        <input id="toggle-kcals" type="checkbox" checked> Kcals
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="toggle-water" type="checkbox" checked> Eau
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input id="toggle-sleep" type="checkbox"> Sommeil
      </label>
    </div>
    
    <!-- Date filters -->
    <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <select id="date-preset" style="padding:6px 8px;">
        <option value="">— Tous les données —</option>
        <option value="7">Derniers 7 jours</option>
        <option value="30">Derniers 30 jours</option>
        <option value="90">Derniers 90 jours</option>
      </select>
      
      <div style="display:flex; gap:8px; align-items:center;">
        <label>Du:</label>
        <input id="date-start" type="date" style="padding:6px 8px;">
      </div>
      
      <div style="display:flex; gap:8px; align-items:center;">
        <label>Au:</label>
        <input id="date-end" type="date" style="padding:6px 8px;">
      </div>
      
      <button id="apply-date-filter" type="button" class="secondary">Appliquer</button>
    </div>
  </div>

  <div class="card">
    <h3>Comparaisons</h3>
    <div id="summary-7days-loader" class="loading-container">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    <div id="summary-7days-container" style="display:none; font-size:0.9rem;">
      <p style="color:#64748b; margin:0 0 8px 0; font-size:0.85rem;">Les 4 tableaux ci-dessous affichent toutes les comparaisons disponibles</p>
    </div>
  </div>
</div>

<!-- New Comparisons: 2 weeks and 4 weeks -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
  <div class="card">
    <h3>S vs S-1</h3>
    <div id="comparison-1-loader" class="loading-container">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    <div id="comparison-1-container" style="display:none;">
      <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <tbody id="comparison-1-body"></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3>S vs S-2</h3>
    <div id="comparison-2-loader" class="loading-container">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    <div id="comparison-2-container" style="display:none;">
      <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <tbody id="comparison-2-body"></tbody>
      </table>
    </div>
  </div>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
  <div class="card">
    <h3>S-1 vs S-2</h3>
    <div id="comparison-3-loader" class="loading-container">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    <div id="comparison-3-container" style="display:none;">
      <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <tbody id="comparison-3-body"></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3>S-1 vs S-3</h3>
    <div id="comparison-4-loader" class="loading-container">
      <div class="spinner"></div>
      <span>Chargement...</span>
    </div>
    <div id="comparison-4-container" style="display:none;">
      <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <tbody id="comparison-4-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Full width: Poids & journaux -->
<div class="card" style="margin-bottom:12px;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <h3 style="margin:0;">Poids & Santé</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="journal-prev-period" class="secondary" style="padding:6px 12px;">← Précédent</button>
      <select id="journal-view-mode" style="padding:6px 8px;">
        <option value="week">Semaine</option>
        <option value="month">Mois</option>
      </select>
      <button id="journal-next-period" class="secondary" style="padding:6px 12px;">Suivant →</button>
    </div>
  </div>

  <!-- Stats cards row -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:12px;">
    <div style="background:#f8fafc; border-radius:6px; padding:12px; border-left:4px solid #0b63d6;">
      <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">Poids moyen</div>
      <div style="font-size:1.5rem; font-weight:700; color:#0b63d6;" id="journal-avg-weight">—</div>
    </div>
    <div style="background:#f8fafc; border-radius:6px; padding:12px; border-left:4px solid #10b981;">
      <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">Kcals moyen</div>
      <div style="font-size:1.5rem; font-weight:700; color:#10b981;" id="journal-avg-kcals">—</div>
    </div>
    <div style="background:#f8fafc; border-radius:6px; padding:12px; border-left:4px solid #f59e0b;">
      <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">Eau moyenne</div>
      <div style="font-size:1.5rem; font-weight:700; color:#f59e0b;" id="journal-avg-water">—</div>
    </div>
    <div style="background:#f8fafc; border-radius:6px; padding:12px; border-left:4px solid #8b5cf6;">
      <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">Sommeil moyen</div>
      <div style="font-size:1.5rem; font-weight:700; color:#8b5cf6;" id="journal-avg-sleep">—</div>
    </div>
  </div>

  <!-- Chart -->
  <div style="position:relative; height:250px; margin-bottom:12px;">
    <canvas id="chart-journal"></canvas>
  </div>

  <!-- Data table -->
  <div style="margin-top:20px;">
    <h4 style="margin:0 0 12px 0; color:#334155;">Données détaillées</h4>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
          <tr style="background:#f1f5f9; border-bottom:2px solid #cbd5e1;">
            <th style="padding:10px; text-align:left; font-weight:600;">Date</th>
            <th style="padding:10px; text-align:center; font-weight:600;">Poids (kg)</th>
            <th style="padding:10px; text-align:center; font-weight:600;">Kcals</th>
            <th style="padding:10px; text-align:center; font-weight:600;">Eau (ml)</th>
            <th style="padding:10px; text-align:center; font-weight:600;">Sommeil (h)</th>
          </tr>
        </thead>
        <tbody id="journal-table-body">
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Performances -->
<div class="card" style="margin-bottom:12px;">
  <h3>Performances par exercice</h3>
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
    <select id="stats-exercise-select">
      <option value="">— choisir un exercice —</option>
    </select>
    <button id="clear-exercise" type="button" class="secondary">Effacer</button>
    <div id="performance-loader" class="loading-container" style="margin-left:12px;">
      <div class="spinner"></div>
      <span style="font-size:0.9rem;">Chargement...</span>
    </div>
  </div>
    
    <!-- Performance Chart by Date -->
    <div id="perf-chart-container" style="display:none; margin-bottom:20px;">
      <h4 style="color: #0b63d6; margin-bottom: 12px;">Évolution de la performance</h4>
      <canvas id="chart-performance" height="100"></canvas>
    </div>

    <!-- Main Series Table -->
    <div id="main-series-container" style="display:none; margin-bottom:20px;">
      <h4 style="color: #0b63d6; margin-bottom: 12px;">Séries principales</h4>
      <table id="main-series-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
            <th style="padding:12px; text-align:left; font-weight:600;">Date</th>
            <th style="padding:12px; text-align:center; font-weight:600;">Reps</th>
            <th style="padding:12px; text-align:center; font-weight:600;">Poids (kg)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Other Series Chart -->
    <div id="other-series-chart-container" style="display:none; margin-bottom:20px;">
      <h4 style="color: #0b63d6; margin-bottom: 12px;">Autres séries - Évolution</h4>
      <canvas id="chart-other-series" height="100"></canvas>
    </div>
    
    <!-- Other Series Table -->
    <div id="other-series-container" style="display:none;">
      <h4 style="color: #0b63d6; margin-bottom: 12px;">Autres séries (moyennes)</h4>
      <table id="other-series-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
            <th style="padding:12px; text-align:left; font-weight:600;">Date</th>
            <th style="padding:12px; text-align:center; font-weight:600;">Reps (moy.)</th>
            <th style="padding:12px; text-align:center; font-weight:600;">Poids moy. (kg)</th>
            <th style="padding:12px; text-align:center; font-weight:600;">Nombre</th>
          </tr>
        </thead>
      <tbody></tbody>
    </table>
    </div>
  </div>
</div>

<!-- Modal for muscle detail -->
<div id="muscle-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 25px rgba(0,0,0,0.15);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="muscle-detail-title" style="margin:0;">Détail par exercice</h3>
      <button onclick="document.getElementById('muscle-detail-modal').style.display='none';" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">×</button>
    </div>
    <div id="muscle-detail-content" style="color:#333; display:flex; justify-content:center; align-items:center; min-height:100px;">
      <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
        <div class="spinner"></div>
        <span style="color:#94a3b8; font-size:0.9rem;">Chargement des détails...</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal for exercise series detail -->
<div id="series-detail-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1001; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:8px; padding:24px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 25px rgba(0,0,0,0.15);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="series-detail-title" style="margin:0;">Détail des séries</h3>
      <button onclick="document.getElementById('series-detail-modal').style.display='none';" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">×</button>
    </div>
    <div id="series-detail-content" style="color:#333; display:flex; justify-content:center; align-items:center; min-height:100px;">
      <div style="display:flex; flex-direction:column; align-items:center; gap:12px;">
        <div class="spinner"></div>
        <span style="color:#94a3b8; font-size:0.9rem;">Chargement des séries...</span>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/coach_stats.js') }}"></script>
{% endblock %}