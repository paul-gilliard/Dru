{% extends 'base.html' %}
{% block title %}Éditer programme — {{ program.name }}{% endblock %}
{% block content %}
<h2 style="margin-bottom: 20px;">Éditer : {{ program.name }} — {{ program.athlete.username }}</h2>

<div class="card programming-edit-root">
  <!-- form id important pour soumission depuis les boutons flottants -->
  <form id="program-form" method="post" action="{{ url_for('coach_programming_edit', program_id=program.id) }}">
    {# Affichage vertical : chaque jour sur sa ligne #}
    <div class="programming-edit" style="display:flex; flex-direction:column; gap:16px;">
      {% for day in range(7) %}
      <div class="card day-row">
        <h4 style="margin-bottom:12px; color:#0b63d6; font-size:1.1rem;">{{ ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'][day] }}</h4>
        <div class="form-row-horizontal">
          <div class="form-group-inline">
            <label>Nom de la séance</label>
            <input type="text" name="session_name_{{ day }}" value="{{ sessions_by_day[day].session_name if sessions_by_day[day] else '' }}" placeholder="Ex: Jambes">
          </div>
        </div>

        <div style="margin-top:14px;">
          <div class="table-wrap">
            <table class="programming-table">
              <thead>
                <tr>
                  <th style="text-align:left;">Exercice</th>
                  <th style="width:50px;">Séries</th>
                  <th style="width:60px;">Rép</th>
                  <th style="width:70px;">Rest (s)</th>
                  <th style="width:45px;">RIR</th>
                  <th style="width:60px;">Int</th>
                  <th style="width:70px;">Muscle</th>
                  <th style="width:80px;">Remarque</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody id="tbody_day_{{ day }}">
                {% if sessions_by_day[day] %}
                  {% for ex in sessions_by_day[day].exercises %}
                  <tr>
                    <td><select name="ex_name_{{ day }}[]" class="exercise-select" data-value="{{ ex.name or '' }}"><option>-- Sélectionner --</option></select></td>
                    <td><input type="number" name="ex_sets_{{ day }}[]" value="{{ ex.sets }}" min="1" max="20"></td>
                    <td><input type="number" name="ex_reps_{{ day }}[]" value="{{ ex.reps }}" min="1" max="100" placeholder="5-10"></td>
                    <td><input type="number" name="ex_rest_{{ day }}[]" value="{{ ex.rest }}" min="0" max="300" placeholder="60"></td>
                    <td><input type="number" name="ex_rir_{{ day }}[]" value="{{ ex.rir }}" min="0" max="10" placeholder="2"></td>
                    <td><input type="text" name="ex_int_{{ day }}[]" value="{{ ex.intensification }}" placeholder="70%"></td>
                    <td><input type="text" name="ex_musc_{{ day }}[]" value="{{ ex.muscle }}" placeholder="Auto"></td>
                    <td><input type="text" name="ex_rem_{{ day }}[]" value="{{ ex.remark }}" placeholder="Notes..."></td>
                    <td><button type="button" class="remove-row btn-remove">✕</button></td>
                  </tr>
                  {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
          <div style="margin-top:12px;">
            <button type="button" class="add-row btn-add-exercise" data-day="{{ day }}">+ Ajouter un exercice</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>
</div>

<!-- Floating actions (always visible left) -->
<div class="floating-actions" aria-hidden="false">
  <button id="save-float" class="save-program-btn" title="Enregistrer le programme">Enregistrer</button>
  <button id="cancel-float" class="cancel-btn" data-return-url="{{ url_for('coach_programming') }}" title="Ne pas enregistrer">Annuler</button>
</div>

<!-- Confirmation modal (hidden by default) -->
<div id="confirm-modal" class="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="confirm-modal-backdrop"></div>
  <div class="confirm-modal-panel" role="document">
    <div class="confirm-modal-body">
      <p id="confirm-message">Confirmez votre action</p>
    </div>
    <div class="confirm-modal-actions">
      <button id="confirm-yes" class="confirm-yes">Confirmer</button>
      <button id="confirm-no" class="confirm-no">Annuler</button>
    </div>
  </div>
</div>

<!-- Row template hidden -->
<table style="display:none;">
  <tbody id="row-template">
    <tr>
      <td><select name="__NAME__" class="exercise-select" data-value=""><option>-- Sélectionner --</option></select></td>
      <td><input type="number" name="__SETS__" value="" min="1" max="20"></td>
      <td><input type="number" name="__REPS__" value="" min="1" max="100" placeholder="5-10"></td>
      <td><input type="number" name="__REST__" value="" min="0" max="300" placeholder="60"></td>
      <td><input type="number" name="__RIR__" value="" min="0" max="10" placeholder="2"></td>
      <td><input type="text" name="__INT__" value="" placeholder="70%"></td>
      <td><input type="text" name="__MUSC__" value="" placeholder="Auto"></td>
      <td><input type="text" name="__REM__" value="" placeholder="Notes..."></td>
      <td><button type="button" class="remove-row btn-remove">✕</button></td>
    </tr>
  </tbody>
</table>

<script>
// Charger les exercices disponibles et remplir les selects
document.addEventListener('DOMContentLoaded', function() {
  fetch('{{ url_for("coach_exercises_json") }}')
    .then(response => response.json())
    .then(exercises => {
      // Remplir tous les selects avec les options d'exercices
      document.querySelectorAll('.exercise-select').forEach(select => {
        const currentValue = select.getAttribute('data-value') || select.value;
        
        select.innerHTML = '<option value="">-- Sélectionner un exercice --</option>';
        exercises.forEach(ex => {
          const option = document.createElement('option');
          option.value = ex.name;
          option.textContent = `${ex.name} (${ex.muscle_group})`;
          select.appendChild(option);
        });
        
        // Restaurer la valeur sélectionnée
        if (currentValue) {
          select.value = currentValue;
        }
      });
    })
    .catch(err => console.error('Erreur chargement exercices:', err));
});
</script>

<script src="{{ url_for('static', filename='js/programming.js') }}"></script>
{% endblock %}